name: Restore protected instructor files

on:
  push:

permissions:
  contents: write

jobs:
  restore:
    # prevent infinite loop after restore commit
    if: ${{ github.event.head_commit.message != 'Restore protected instructor files' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch instructor default branch
        run: |
          git fetch origin basicsofProgramming26:refs/remotes/origin/basicsofProgramming26

      - name: Restore protected instructor files
        run: |
          set -e

          PROTECTED_FILES=(
            "README.md"
            "LOCAL_SETUP_GUIDE.md"
            ".gitignore"

            ".github/workflows/restore-protected.yml"

            "part1/grade_part1.py"
            "part2/grade_part2.py"
            "part3/grade_part3.py"
            "part4/grade_part4.py"
            "part6/grade_part6.py"
          )

          NEED_RESTORE=0

          for f in "${PROTECTED_FILES[@]}"; do
            # check file exists in instructor branch
            if git cat-file -e "origin/basicsofProgramming26:$f" 2>/dev/null; then
              if ! git diff --quiet origin/basicsofProgramming26 -- "$f"; then
                echo "Restoring: $f"
                NEED_RESTORE=1
              fi
            fi
          done

          if [ "$NEED_RESTORE" -eq 0 ]; then
            echo "No protected files modified."
            exit 0
          fi

          echo "Restoring files from instructor branch..."

          git checkout origin/basicsofProgramming26 -- "${PROTECTED_FILES[@]}"

          git config user.name "github-classroom-bot"
          git config user.email "noreply@github.com"

          git add "${PROTECTED_FILES[@]}"
          git commit -m "Restore protected instructor files" || exit 0
          git push
